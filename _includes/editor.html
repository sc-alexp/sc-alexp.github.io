<div class="w-100 bg-body-tertiary p-2 text-center">
  <div class="btn-group m-1" role="group">
    <!-- Existing Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Bold"
      onClick="applyBold()"
    >
      <i class="bi bi-type-bold"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Italic"
      onClick="applyItalics()"
    >
      <i class="bi bi-type-italic"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Underline"
      onClick="applyUnderline()"
    >
      <i class="bi bi-type-underline"></i>
    </button>
  </div>
  <!-- New Link Button -->
  <button
    type="button"
    class="btn py-1 px-2 fs-5 btn-outline-secondary"
    data-bs-toggle="tooltip"
    data-bs-placement="bottom"
    data-bs-custom-class="custom-tooltip"
    data-bs-title="Link"
    onClick="applyLink()"
  >
    <i class="bi bi-link-45deg"></i>
  </button>
  <div class="btn-group m-1" role="group">
    <!-- New List Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="List"
      onClick="applyList()"
    >
      <i class="bi bi-list-ul"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Numbered List"
      onClick="applyNumberedList()"
    >
      <i class="bi bi-list-ol"></i>
    </button>
  </div>
  <div class="btn-group m-1" role="group">
    <!-- Existing Alignment Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Left"
      onClick="alignLeft()"
    >
      <i class="bi bi-text-left"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Center"
      onClick="alignCenter()"
    >
      <i class="bi bi-text-center"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Right"
      onClick="alignRight()"
    >
      <i class="bi bi-text-right"></i>
    </button>
  </div>
  <!-- New Image Button -->
  <button
    type="button"
    class="btn py-1 px-2 fs-5 btn-outline-secondary"
    data-bs-toggle="tooltip"
    data-bs-placement="bottom"
    data-bs-custom-class="custom-tooltip"
    data-bs-title="Image"
    onClick="insertImage()"
  >
    <i class="bi bi-card-image"></i>
  </button>
  <div class="btn-group m-1" role="group">
    <!-- New Heading Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 1"
      onClick="applyHeading(1)"
    >
      <i class="bi bi-type-h1"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 2"
      onClick="applyHeading(2)"
    >
      <i class="bi bi-type-h2"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 3"
      onClick="applyHeading(3)"
    >
      <i class="bi bi-type-h3"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Normal"
      onClick="applyNormal()"
    >
      <i class="bi bi-type"></i>
    </button>
  </div>
  <div class="btn-group m-1" role="group">
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-danger"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Clear"
      onClick="clearText()"
    >
      <i class="bi bi-x-lg"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-success"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Copy for Ticket"
      onClick="copyForTicket()"
    >
      <i class="bi bi-clipboard"></i>
    </button>
  </div>
</div>
<div class="w-100 px-5">
  <textarea class="form-control w-100" id="editor-textarea"></textarea>
</div>

<!-- Include the Marked.js library for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });
  });

  function adjustTextareaHeight() {
    const navbarHeight = document.querySelector(".navbar").offsetHeight;
    const buttonGroupHeight =
      document.querySelector(".fixed-bottom").offsetHeight;
    const viewportHeight = window.innerHeight / 2;
    const availableHeight = viewportHeight - navbarHeight - buttonGroupHeight;

    document.getElementById("editor-textarea").style.height =
      availableHeight + "px";
  }

  // Adjust the textarea height on page load and when the window is resized
  window.addEventListener("load", adjustTextareaHeight);
  window.addEventListener("resize", adjustTextareaHeight);

  /* Existing Button Functionality */
  function applyBold() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    // Surround the selected text with **
    const newText = `**${selectedText}**`;

    // Replace the selected text with the new text
    textarea.value =
      textarea.value.substring(0, start) +
      newText +
      textarea.value.substring(end);

    // Adjust the selection to keep the text selected
    textarea.selectionStart = start;
    textarea.selectionEnd = start + newText.length;

    textarea.dispatchEvent(new Event("input"));
    // Focus back on the textarea
    textarea.focus();
  }

  function applyItalics() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    // Surround the selected text with *
    const newText = `*${selectedText}*`;

    // Replace the selected text with the new text
    textarea.value =
      textarea.value.substring(0, start) +
      newText +
      textarea.value.substring(end);

    // Adjust the selection to keep the text selected
    textarea.selectionStart = start;
    textarea.selectionEnd = start + newText.length;

    textarea.dispatchEvent(new Event("input"));
    // Focus back on the textarea
    textarea.focus();
  }

  function applyUnderline() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    // Use HTML <u> tag as Markdown doesn't support underline
    const newText = `<u>${selectedText}</u>`;

    // Replace the selected text with the new text
    textarea.value =
      textarea.value.substring(0, start) +
      newText +
      textarea.value.substring(end);

    // Adjust the selection to keep the text selected
    textarea.selectionStart = start;
    textarea.selectionEnd = start + newText.length;

    textarea.dispatchEvent(new Event("input"));
    // Focus back on the textarea
    textarea.focus();
  }

  function alignLeft() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // Find the start and end of the line(s)
    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    // Wrap with HTML div for alignment
    const newText = `<div style="text-align: left;">${selectedText}</div>`;

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function alignCenter() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    const newText = `<div style="text-align: center;">${selectedText}</div>`;

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function alignRight() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    const newText = `<div style="text-align: right;">${selectedText}</div>`;

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  /* New Button Functionality */
  function applyLink() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    let selectedText = textarea.value.substring(start, end);

    let url = prompt("Enter the URL:");
    if (url === null) return; // User cancelled

    if (selectedText === "") {
      selectedText = prompt("Enter the text for the link:", "link text");
      if (selectedText === null) return; // User cancelled
    }

    // Create the markdown link
    const newText = `[${selectedText}](${url})`;

    // Replace the selected text with the new text
    textarea.value =
      textarea.value.substring(0, start) +
      newText +
      textarea.value.substring(end);

    // Adjust the selection to the new text
    textarea.selectionStart = start;
    textarea.selectionEnd = start + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyList() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    const lines = selectedText.split("\n");

    const newLines = lines.map((line) => {
      // Avoid adding '- ' if it's already there
      if (line.startsWith("- ")) {
        return line;
      } else {
        return "- " + line;
      }
    });

    const newText = newLines.join("\n");

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyNumberedList() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    const lines = selectedText.split("\n");

    const newLines = lines.map((line, index) => {
      // Check if line already starts with a number
      if (/^\d+\. /.test(line)) {
        return line;
      } else {
        return index + 1 + ". " + line;
      }
    });

    const newText = newLines.join("\n");

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function insertImage() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);

    let imageUrl = prompt("Enter the image URL:");
    if (imageUrl === null) return;

    let altText =
      selectedText || prompt("Enter the alt text:", "image description");
    if (altText === null) return;

    const newText = `![${altText}](${imageUrl})`;

    textarea.value =
      textarea.value.substring(0, start) +
      newText +
      textarea.value.substring(end);

    textarea.selectionStart = start;
    textarea.selectionEnd = start + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyHeading(level) {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    // Remove existing heading markers
    let newText = selectedText.replace(/^#+\s*/, "");

    // Add new heading markers
    const headingPrefix = "#".repeat(level) + " ";
    newText = headingPrefix + newText;

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyNormal() {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    // Remove existing heading markers
    const newText = selectedText.replace(/^#+\s*/, "");

    textarea.value =
      value.substring(0, lineStart) + newText + value.substring(actualLineEnd);

    textarea.selectionStart = lineStart;
    textarea.selectionEnd = lineStart + newText.length;

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  /* Keyboard Shortcuts (Optional) */
  document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById("editor-textarea");
    if (textarea) {
      textarea.addEventListener("keydown", function (event) {
        if (event.ctrlKey && event.key.toLowerCase() === "b") {
          event.preventDefault(); // Prevent the default browser behavior
          applyBold(); // Call the applyBold function
        }
        // Add more keyboard shortcuts if needed
      });
    }
  });

  function clearText() {
    const textarea = document.getElementById("editor-textarea");
    if (confirm("Are you sure you want to clear the text area?")) {
      textarea.value = "";
      textarea.dispatchEvent(new Event("input"));
      textarea.focus();
    }
  }

  function copyForTicket() {
    const textarea = document.getElementById("editor-textarea");
    const markdownText = textarea.value;

    // Convert Markdown to HTML using Marked.js
    const htmlContent = marked(markdownText);

    // Split the HTML content into lines
    const lines = htmlContent.split("\n");

    // Wrap each line with [code] and [/code]
    const wrappedLines = lines.map((line) => `[code]${line}[/code]`);

    // Join the lines back together
    const result = wrappedLines.join("\n");

    // Create a temporary textarea to hold the text
    const tempTextarea = document.createElement("textarea");
    tempTextarea.value = result;
    document.body.appendChild(tempTextarea);

    // Select the text
    tempTextarea.select();
    tempTextarea.setSelectionRange(0, tempTextarea.value.length);

    // Copy the text
    try {
      document.execCommand("copy");
      alert("Copied to clipboard.");
    } catch (err) {
      alert("Failed to copy text.");
    }

    // Remove the temporary textarea
    document.body.removeChild(tempTextarea);
  }
</script>
