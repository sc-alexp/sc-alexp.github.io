<div class="w-100 bg-body-tertiary p-2 text-center">
  <div class="btn-group m-1" role="group">
    <!-- Existing Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Bold"
      onClick="applyBold()"
    >
      <i class="bi bi-type-bold"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Italic"
      onClick="applyItalics()"
    >
      <i class="bi bi-type-italic"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Underline"
      onClick="applyUnderline()"
    >
      <i class="bi bi-type-underline"></i>
    </button>
  </div>
  <!-- New Link Button -->
  <button
    type="button"
    class="btn py-1 px-2 fs-5 btn-outline-secondary"
    data-bs-toggle="tooltip"
    data-bs-placement="bottom"
    data-bs-custom-class="custom-tooltip"
    data-bs-title="Link"
    onClick="applyLink()"
  >
    <i class="bi bi-link-45deg"></i>
  </button>
  <div class="btn-group m-1" role="group">
    <!-- New List Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="List"
      onClick="applyList()"
    >
      <i class="bi bi-list-ul"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Numbered List"
      onClick="applyNumberedList()"
    >
      <i class="bi bi-list-ol"></i>
    </button>
  </div>
  <div class="btn-group m-1" role="group">
    <!-- Existing Alignment Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Left"
      onClick="alignLeft()"
    >
      <i class="bi bi-text-left"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Center"
      onClick="alignCenter()"
    >
      <i class="bi bi-text-center"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Align Right"
      onClick="alignRight()"
    >
      <i class="bi bi-text-right"></i>
    </button>
  </div>
  <!-- New Image Button -->
  <button
    type="button"
    class="btn py-1 px-2 fs-5 btn-outline-secondary"
    data-bs-toggle="tooltip"
    data-bs-placement="bottom"
    data-bs-custom-class="custom-tooltip"
    data-bs-title="Image"
    onClick="insertImage()"
  >
    <i class="bi bi-card-image"></i>
  </button>
  <div class="btn-group m-1" role="group">
    <!-- New Heading Buttons -->
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 1"
      onClick="applyHeading(1)"
    >
      <i class="bi bi-type-h1"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 2"
      onClick="applyHeading(2)"
    >
      <i class="bi bi-type-h2"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Heading 3"
      onClick="applyHeading(3)"
    >
      <i class="bi bi-type-h3"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-outline-secondary"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Normal"
      onClick="applyNormal()"
    >
      <i class="bi bi-type"></i>
    </button>
  </div>
  <div class="btn-group m-1" role="group">
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-danger"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Clear"
      onClick="clearText()"
    >
      <i class="bi bi-x-lg"></i>
    </button>
    <button
      type="button"
      class="btn py-1 px-2 fs-5 btn-success"
      data-bs-toggle="tooltip"
      data-bs-placement="bottom"
      data-bs-custom-class="custom-tooltip"
      data-bs-title="Copy for Ticket"
      onClick="copyForTicket()"
    >
      <i class="bi bi-clipboard"></i>
    </button>
  </div>
</div>
<div class="w-100 px-5">
  <textarea class="form-control w-100" id="editor-textarea"></textarea>
</div>

<script>
  // Initialize the Showdown converter with simpleLineBreaks option
  const converter = new showdown.Converter({ simpleLineBreaks: true });

  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(
      document.querySelectorAll('[data-bs-toggle="tooltip"]')
    );
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Get the textarea
    const textarea = document.getElementById("editor-textarea");

    // New code to handle templates
    const urlParams = new URLSearchParams(window.location.search);
    const template = urlParams.get("template");

    if (template && textarea) {
      let templateText = "";
      if (template === "basic") {
        templateText = `Hello,

Thank you for contacting the ISU ITS Solution Center.

Best,

<a href="https://www.it.iastate.edu/help" target="_blank"><img src="https://www.stugov.iastate.edu/files/2024-11/IT%20Solution%20Center%20Workmark.svg" style="width: 100%; max-width: 225px" alt="IT Solution Center"></a>`;
      } else if (template === "callnotes") {
        templateText = `â˜Ž Call Notes:

- Notes here

End call`;
      }

      // Set the textarea value
      textarea.value = templateText;

      // Update the preview
      const htmlContent = converter.makeHtml(templateText);
      // Update your preview area if needed
      // document.getElementById("preview").innerHTML = htmlContent;

      // Alternatively, dispatch an input event to trigger the listener
      textarea.dispatchEvent(new Event("input"));
    }

    // Update the preview area (if you have one)
    if (textarea) {
      textarea.addEventListener("input", function () {
        const markdownText = this.value;
        const htmlContent = converter.makeHtml(markdownText);
        // Update your preview area if needed
        // document.getElementById("preview").innerHTML = htmlContent;
      });
    }
  });

  function adjustTextareaHeight() {
    const navbarHeight = document.querySelector(".navbar").offsetHeight;
    const buttonGroupHeight =
      document.querySelector(".fixed-bottom").offsetHeight;
    const viewportHeight = window.innerHeight / 2;
    const availableHeight = viewportHeight - navbarHeight - buttonGroupHeight;

    document.getElementById("editor-textarea").style.height =
      availableHeight + "px";
  }

  // Adjust the textarea height on page load and when the window is resized
  window.addEventListener("load", adjustTextareaHeight);
  window.addEventListener("resize", adjustTextareaHeight);

  /* Existing Button Functionality */
  function applyBold() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // Surround the selected text with **
    const newText = `**${textarea.value.substring(start, end)}**`;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyItalics() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // Surround the selected text with *
    const newText = `*${textarea.value.substring(start, end)}*`;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyUnderline() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // Use HTML <u> tag as Markdown doesn't support underline
    const newText = `<u>${textarea.value.substring(start, end)}</u>`;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function alignLeft() {
    applyAlignment("left");
  }

  function alignCenter() {
    applyAlignment("center");
  }

  function alignRight() {
    applyAlignment("right");
  }

  function applyAlignment(alignment) {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    // Find the start and end of the line(s)
    const lineStart = value.lastIndexOf("\n", start) + 1;
    const lineEnd = value.indexOf("\n", end);
    const actualLineEnd = lineEnd === -1 ? value.length : lineEnd;

    const selectedText = value.substring(lineStart, actualLineEnd);

    // Wrap with HTML div for alignment
    const newText = `<div style="text-align: ${alignment};">${selectedText}</div>`;

    textarea.setRangeText(newText, lineStart, actualLineEnd, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  /* New Button Functionality */
  function applyLink() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    let selectedText = textarea.value.substring(start, end);

    let url = prompt("Enter the URL:");
    if (url === null) return; // User cancelled

    if (selectedText === "") {
      selectedText = prompt("Enter the text for the link:", "link text");
      if (selectedText === null) return; // User cancelled
    }

    // Create the markdown link
    const newText = `[${selectedText}](${url})`;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyList() {
    applyListStyle("- ");
  }

  function applyNumberedList() {
    applyListStyle("1. ", true);
  }

  function applyListStyle(prefix, isNumbered = false) {
    const textarea = document.getElementById("editor-textarea");
    const value = textarea.value;
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const selectedText = value.slice(start, end);

    const lines = selectedText.split("\n");

    const newLines = lines.map((line, index) => {
      if (isNumbered) {
        return `${index + 1}. ${line.replace(/^\d+\. /, "")}`;
      } else {
        return `${prefix}${line.replace(/^- /, "")}`;
      }
    });

    const newText = newLines.join("\n");

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function insertImage() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    let imageUrl = prompt("Enter the image URL:");
    if (imageUrl === null) return;

    let altText =
      textarea.value.substring(start, end) ||
      prompt("Enter the alt text:", "image description");
    if (altText === null) return;

    const newText = `![${altText}](${imageUrl})`;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyHeading(level) {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const selectedText = textarea.value.slice(start, end);

    // Remove existing heading markers
    let newText = selectedText.replace(/^#+\s*/, "");

    // Add new heading markers
    const headingPrefix = "#".repeat(level) + " ";
    newText = headingPrefix + newText;

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  function applyNormal() {
    const textarea = document.getElementById("editor-textarea");
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;

    const selectedText = textarea.value.substring(start, end);

    // Remove existing heading markers
    const newText = selectedText.replace(/^#+\s*/, "");

    textarea.setRangeText(newText, start, end, "select");

    textarea.dispatchEvent(new Event("input"));
    textarea.focus();
  }

  /* Keyboard Shortcuts (Optional) */
  document.addEventListener("DOMContentLoaded", function () {
    const textarea = document.getElementById("editor-textarea");
    if (textarea) {
      textarea.addEventListener("keydown", function (event) {
        if (event.ctrlKey && event.key.toLowerCase() === "b") {
          event.preventDefault(); // Prevent the default browser behavior
          applyBold(); // Call the applyBold function
        }
        // Add more keyboard shortcuts if needed
      });
    }
  });

  function clearText() {
    const textarea = document.getElementById("editor-textarea");
    if (confirm("Are you sure you want to clear the text area?")) {
      textarea.value = "";
      textarea.dispatchEvent(new Event("input"));
      textarea.focus();
      window.location.replace("/");
    }
  }

  function copyForTicket() {
    const textarea = document.getElementById("editor-textarea");
    const markdownText = textarea.value;

    // Convert Markdown to HTML using Showdown
    const htmlContent = converter.makeHtml(markdownText);

    // Wrap the entire HTML content with [code] and [/code]
    const result = `[code]${htmlContent}[/code]`;

    // Copy the result to the clipboard
    navigator.clipboard.writeText(result).then(
      function () {
        alert("Copied to clipboard.");
      },
      function (err) {
        alert("Could not copy text: " + err);
      }
    );
  }
</script>
